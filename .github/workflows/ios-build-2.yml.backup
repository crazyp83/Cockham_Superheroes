name: Build Ren'Py iOS App 2

on: push

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download Ren'Py SDK
        run: |
          curl -o renpy-sdk.zip https://www.renpy.org/dl/8.3.7/renpy-8.3.7-sdk.zip
          unzip renpy-sdk.zip -d renpy

      - name: Download and install rapt
        run: |
          curl -o rapt.zip https://www.renpy.org/dl/8.3.7/renpy-8.3.7-rapt.zip
          unzip rapt.zip -d renpy/renpy-8.3.7-sdk

      - name: Download and install renios
        run: |
          curl -o renios.zip https://www.renpy.org/dl/8.3.7/renpy-8.3.7-renios.zip
          unzip renios.zip -d renpy/renpy-8.3.7-sdk

      - name: Download and install renpyweb
        run: |
          curl -o renpyweb.zip https://www.renpy.org/dl/8.3.7/renpy-8.3.7-web.zip
          unzip renpyweb.zip -d renpy/renpy-8.3.7-sdk

      - name: Build for iOS
        run: |
          cd renpy/renpy-8.3.7-sdk
          ./renpy.sh launcher ios_create "$GITHUB_WORKSPACE" ios
          ./renpy.sh launcher ios_populate "$GITHUB_WORKSPACE" ios

      - name: Create application Bundle and convert to .ipa
        run: |
          # Create a temporary directory within the GitHub workspace
          mkdir -p "$GITHUB_WORKSPACE/temp/Payload"
          
          # Find the .app bundle generated in the ios directory (assuming it exists)
          APP_BUNDLE=$(find "/" -name "*.app" -type d -maxdepth 5 | head -n 1)
          if [ -z "$APP_BUNDLE" ]; then
            echo "Error: No .app bundle found in $GITHUB_WORKSPACE/ios"
            exit 1
          fi
          
          # Move and rename the app bundle
          mv "$APP_BUNDLE" "$GITHUB_WORKSPACE/temp/Payload/Cockham Superheros.app"
          
          # Navigate to the temp directory and create the IPA
          cd "$GITHUB_WORKSPACE/temp"
          zip -r --symlinks "Cockham Superheros.ipa" Payload/

      - name: Create release and upload asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITEATOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" "$GITHUB_WORKSPACE/temp/Cockham Superheros.ipa" \
            --title "Release ${{ github.ref_name }}" \
            --notes "Automated release"