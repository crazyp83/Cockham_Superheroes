name: Build Ren'Py iOS App test 4

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download Ren'Py SDK
      run: |
        curl -o renpy-sdk.zip https://www.renpy.org/dl/8.3.7/renpy-8.3.7-sdk.zip
        unzip renpy-sdk.zip -d renpy

    - name: Download and install rapt
      run: |
        curl -o rapt.zip https://www.renpy.org/dl/8.3.7/renpy-8.3.7-rapt.zip
        unzip rapt.zip -d renpy/renpy-8.3.7-sdk

    - name: Download and install renios
      run: |
        curl -o renios.zip https://www.renpy.org/dl/8.3.7/renpy-8.3.7-renios.zip
        unzip renios.zip -d renpy/renpy-8.3.7-sdk

    - name: Download and install renpyweb
      run: |
        curl -o renpyweb.zip https://www.renpy.org/dl/8.3.7/renpy-8.3.7-web.zip
        unzip renpyweb.zip -d renpy/renpy-8.3.7-sdk
    - name: Build for iOS 
      run: |
        cd renpy/renpy-8.3.7-sdk
        ./renpy.sh launcher ios_create $GITHUB_WORKSPACE ios
        ./renpy.sh launcher ios_populate $GITHUB_WORKSPACE ios
 

# Create a GitHub release using the provided access token
    - name: Create GitHub release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        draft: false
        prerelease: false

      # Upload the IPA file as a release asset
    - name: Upload IPA to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./renpy/renpy-8.3.7-sdk/ios/CockhamSuperheroes.ipa
        asset_name: CockhamSuperheroes.ipa
        asset_content_type: application/octet-stream
        run: ls